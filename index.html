<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEFCON: RELATIONSHIP â€” Threat Assessment System</title>
<meta name="description" content="Cross-references text response times, emoji usage, and calendar events to predict relationship danger zones.">
<meta property="og:title" content="DEFCON: RELATIONSHIP">
<meta property="og:description" content="Upload your chat export. We'll tell you how much trouble you're in.">
<meta property="og:type" content="website">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš¨</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0a0a0a;
  --bg-secondary: #111;
  --bg-card: #1a1a1a;
  --border: #2a2a2a;
  --green: #00ff41;
  --green-dim: #00aa2a;
  --yellow: #ffdd00;
  --orange: #ff8c00;
  --red: #ff0040;
  --red-glow: rgba(255, 0, 64, 0.3);
  --text: #c0c0c0;
  --text-bright: #e0e0e0;
  --mono: 'JetBrains Mono', 'Courier New', monospace;
}

body {
  font-family: var(--mono);
  background: var(--bg-primary);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 1px, transparent 3px);
  pointer-events: none;
  z-index: 9999;
  animation: crtFlicker 0.1s steps(2) 3;
}

@keyframes crtFlicker { 0%{opacity:.8} 50%{opacity:.4} 100%{opacity:.15} }

/* ========== UPLOAD SCREEN ========== */
.upload-screen {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px;
  transition: opacity 0.5s;
}

.upload-screen.hidden { display: none; }

.upload-screen h1 {
  font-size: clamp(1.6rem, 5vw, 2.8rem);
  font-weight: 700;
  letter-spacing: 6px;
  color: var(--green);
  text-shadow: 0 0 30px rgba(0,255,65,0.4);
  margin-bottom: 8px;
}

.upload-screen .tagline {
  font-size: 0.75rem;
  color: #555;
  letter-spacing: 3px;
  margin-bottom: 48px;
  animation: subtitlePulse 3s ease-in-out infinite;
}

@keyframes subtitlePulse { 0%,100%{opacity:.5} 50%{opacity:1} }

.dropzone {
  width: 100%;
  max-width: 560px;
  border: 2px dashed var(--border);
  border-radius: 16px;
  padding: 64px 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.dropzone:hover, .dropzone.dragover {
  border-color: var(--green);
  background: rgba(0,255,65,0.03);
  box-shadow: 0 0 40px rgba(0,255,65,0.08);
}

.dropzone-icon {
  font-size: 3rem;
  margin-bottom: 16px;
  display: block;
}

.dropzone-title {
  font-size: 1rem;
  color: var(--text-bright);
  margin-bottom: 8px;
}

.dropzone-sub {
  font-size: 0.65rem;
  color: #555;
  line-height: 1.6;
}

.dropzone input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.upload-formats {
  margin-top: 24px;
  font-size: 0.6rem;
  color: #444;
  max-width: 560px;
  text-align: center;
  line-height: 1.8;
}

.upload-divider {
  margin: 40px 0;
  font-size: 0.6rem;
  color: #333;
  letter-spacing: 4px;
  display: flex;
  align-items: center;
  gap: 16px;
  width: 100%;
  max-width: 560px;
}

.upload-divider::before, .upload-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.demo-label {
  font-size: 0.6rem;
  color: #444;
  letter-spacing: 2px;
  margin-bottom: 12px;
}

.demo-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
  max-width: 640px;
}

.demo-btn {
  font-family: var(--mono);
  font-size: 0.6rem;
  padding: 8px 14px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg-card);
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.demo-btn:hover {
  border-color: var(--green-dim);
  color: var(--green);
}

/* ========== ANALYSIS SCREEN (terminal animation) ========== */
.analysis-screen {
  min-height: 100vh;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px;
}

.analysis-screen.active { display: flex; }

.terminal {
  width: 100%;
  max-width: 700px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}

.terminal-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: #1e1e1e;
  border-bottom: 1px solid var(--border);
}

.terminal-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.terminal-dot.red { background: #ff5f57; }
.terminal-dot.yellow { background: #febc2e; }
.terminal-dot.green { background: #28c840; }

.terminal-title {
  font-size: 0.6rem;
  color: #555;
  margin-left: 8px;
  letter-spacing: 2px;
}

.terminal-body {
  padding: 20px;
  min-height: 300px;
  max-height: 500px;
  overflow-y: auto;
  font-size: 0.72rem;
  line-height: 1.8;
}

.terminal-body::-webkit-scrollbar { width: 4px; }
.terminal-body::-webkit-scrollbar-track { background: var(--bg-primary); }
.terminal-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.term-line {
  white-space: pre-wrap;
  word-break: break-word;
}

.term-green { color: var(--green); }
.term-red { color: var(--red); }
.term-orange { color: var(--orange); }
.term-yellow { color: var(--yellow); }
.term-dim { color: #555; }
.term-bright { color: var(--text-bright); }

.cursor {
  display: inline-block;
  width: 8px;
  height: 14px;
  background: var(--green);
  animation: cursorBlink 0.6s steps(1) infinite;
  vertical-align: text-bottom;
}

@keyframes cursorBlink { 0%,100%{opacity:1} 50%{opacity:0} }

/* ========== DASHBOARD ========== */
.dashboard-screen { display: none; }
.dashboard-screen.active { display: block; }

.header {
  text-align: center;
  padding: 24px 16px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, #111 0%, var(--bg-primary) 100%);
}

.header h1 {
  font-size: clamp(1.4rem, 4vw, 2.2rem);
  font-weight: 700;
  letter-spacing: 6px;
  color: var(--green);
  text-shadow: 0 0 20px rgba(0,255,65,0.4);
}

.header .subtitle {
  font-size: 0.7rem;
  color: #555;
  letter-spacing: 4px;
  margin-top: 4px;
}

.source-bar {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
}

.source-info {
  font-size: 0.6rem;
  color: #555;
  letter-spacing: 1px;
}

.source-info strong { color: var(--green); }

.new-analysis-btn {
  font-family: var(--mono);
  font-size: 0.6rem;
  padding: 5px 12px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg-card);
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  margin-left: 16px;
}

.new-analysis-btn:hover {
  border-color: var(--green-dim);
  color: var(--green);
}

.dashboard {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto auto;
  gap: 16px;
  padding: 16px;
  max-width: 1200px;
  margin: 0 auto;
}

.gauge-section { grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; }
.timeline-section { grid-column: 1; display: flex; }
.timeline-section .card { flex: 1; }
.calendar-section { grid-column: 2; display: flex; }
.calendar-section .card { flex: 1; }
.factors-section { grid-column: 1 / -1; }

.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}

.card-header {
  font-size: 0.65rem;
  letter-spacing: 3px;
  color: #555;
  margin-bottom: 12px;
  text-transform: uppercase;
}

/* Gauge */
.gauge-container { position: relative; width: 360px; height: 210px; }
.gauge-container canvas { width: 100%; height: 100%; }
.defcon-display { text-align: center; margin-top: -4px; }
.defcon-number { font-size: 3.5rem; font-weight: 700; line-height: 1; transition: color 0.5s; }
.defcon-label { font-size: 0.85rem; margin-top: 6px; letter-spacing: 3px; transition: color 0.5s; }

.gauge-section.defcon-1 .card {
  box-shadow: 0 0 30px var(--red-glow);
  border-color: var(--red);
  animation: defcon1Pulse 1.5s ease-in-out infinite;
}

@keyframes defcon1Pulse {
  0%,100% { box-shadow: 0 0 20px var(--red-glow); }
  50% { box-shadow: 0 0 50px var(--red-glow), 0 0 80px rgba(255,0,64,0.15); }
}

/* Signals */
.signal-list { max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
.signal-list::-webkit-scrollbar { width: 4px; }
.signal-list::-webkit-scrollbar-track { background: var(--bg-primary); }
.signal-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.signal-item {
  display: flex; align-items: flex-start; gap: 10px; padding: 8px;
  border-radius: 4px; background: rgba(255,255,255,0.02);
  border-left: 3px solid var(--border);
  animation: signalFadeIn 0.3s ease-out; font-size: 0.75rem;
}

@keyframes signalFadeIn { from{opacity:0;transform:translateX(-10px)} to{opacity:1;transform:translateX(0)} }

.signal-item.severity-critical { border-left-color: var(--red); }
.signal-item.severity-high { border-left-color: var(--orange); }
.signal-item.severity-medium { border-left-color: var(--yellow); }
.signal-item.severity-low { border-left-color: var(--green); }

.signal-icon { font-size: 1rem; flex-shrink: 0; }
.signal-body { flex: 1; }
.signal-time { font-size: 0.6rem; color: var(--green-dim); margin-bottom: 2px; }
.signal-text { color: var(--text-bright); }

.signal-badge {
  font-size: 0.55rem; padding: 2px 6px; border-radius: 3px;
  font-weight: 700; letter-spacing: 1px; flex-shrink: 0; align-self: center;
}

.signal-badge.critical { background: rgba(255,0,64,0.2); color: var(--red); }
.signal-badge.high { background: rgba(255,140,0,0.2); color: var(--orange); }
.signal-badge.medium { background: rgba(255,221,0,0.2); color: var(--yellow); }
.signal-badge.low { background: rgba(0,255,65,0.2); color: var(--green); }

/* Calendar */
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.cal-header span { font-size: 0.8rem; color: var(--text-bright); }

.cal-nav {
  font-family: var(--mono); background: none; border: 1px solid var(--border);
  color: var(--text); padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 0.7rem;
}
.cal-nav:hover { border-color: var(--green-dim); color: var(--green); }

.cal-day-name { font-size: 0.55rem; color: #555; text-align: center; padding: 4px 0; }

.cal-day {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; border-radius: 4px; cursor: default; position: relative; transition: all 0.2s;
}

.cal-day.empty { opacity: 0; }
.cal-day.today { outline: 2px solid var(--green); outline-offset: -2px; }
.cal-day.threat-none { background: rgba(0,255,65,0.06); color: var(--green-dim); }
.cal-day.threat-low { background: rgba(0,255,65,0.12); color: var(--green); }
.cal-day.threat-medium { background: rgba(255,221,0,0.12); color: var(--yellow); }
.cal-day.threat-high { background: rgba(255,140,0,0.15); color: var(--orange); }
.cal-day.threat-critical { background: rgba(255,0,64,0.18); color: var(--red); animation: dayPulse 2s ease-in-out infinite; }

@keyframes dayPulse { 0%,100%{background:rgba(255,0,64,0.18)} 50%{background:rgba(255,0,64,0.3)} }

.cal-day .tooltip {
  display: none; position: absolute; bottom: calc(100% + 6px); left: 50%;
  transform: translateX(-50%); background: #222; border: 1px solid var(--border);
  padding: 6px 10px; border-radius: 4px; font-size: 0.6rem; white-space: nowrap;
  color: var(--text-bright); z-index: 10; pointer-events: none;
}
.cal-day:hover .tooltip { display: block; }
.cal-day .event-dot { position: absolute; bottom: 3px; width: 4px; height: 4px; border-radius: 50%; background: currentColor; }

/* Factors */
.factors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
.factor { display: flex; flex-direction: column; gap: 4px; }
.factor-label { display: flex; justify-content: space-between; font-size: 0.65rem; }
.factor-name { color: var(--text); }
.factor-value { font-weight: 700; transition: color 0.5s; }
.factor-bar { height: 8px; background: rgba(255,255,255,0.06); border-radius: 4px; overflow: hidden; }
.factor-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.25,0.46,0.45,0.94), background-color 0.5s; width: 0%; box-shadow: 0 0 8px currentColor; }
.factor-detail { font-size: 0.55rem; color: #555; }

.footer {
  text-align: center; padding: 24px 16px; font-size: 0.55rem;
  color: #333; letter-spacing: 3px; border-top: 1px solid var(--border);
}

@media (max-width: 768px) {
  .dashboard { grid-template-columns: 1fr; }
  .gauge-section, .timeline-section, .calendar-section, .factors-section { grid-column: 1; }
  .gauge-container { width: 260px; height: 170px; }
  .demo-buttons { gap: 6px; }
  .demo-btn { font-size: 0.55rem; padding: 6px 10px; }
}
</style>
</head>
<body>

<!-- ========== SCREEN 1: UPLOAD ========== -->
<div class="upload-screen" id="uploadScreen">
  <h1>DEFCON: RELATIONSHIP</h1>
  <div class="tagline">THREAT ASSESSMENT SYSTEM v2.0</div>

  <div class="dropzone" id="dropzone">
    <input type="file" id="fileInput" accept=".txt,.csv,.text">
    <span class="dropzone-icon">&#x1F4E1;</span>
    <div class="dropzone-title">Drop your chat export here</div>
    <div class="dropzone-sub">
      iMessage &middot; WhatsApp &middot; Telegram &middot; any .txt chat export<br>
      <span style="color:#00aa2a">100% client-side. Your data never leaves your browser.</span>
    </div>
  </div>

  <div class="upload-formats">
    Supports: WhatsApp export ("1/15/24, 9:30 AM - Name: message")<br>
    iMessage export ("[2024-01-15] Name: message") &middot; Generic "timestamp - name: message"
  </div>

  <div class="upload-divider">OR TRY A DEMO</div>

  <div class="demo-label">PRE-BUILT SCENARIOS</div>
  <div class="demo-buttons" id="demoButtons"></div>
</div>

<!-- ========== SCREEN 2: ANALYSIS TERMINAL ========== -->
<div class="analysis-screen" id="analysisScreen">
  <div class="terminal">
    <div class="terminal-bar">
      <div class="terminal-dot red"></div>
      <div class="terminal-dot yellow"></div>
      <div class="terminal-dot green"></div>
      <span class="terminal-title">BIA THREAT ANALYSIS ENGINE</span>
    </div>
    <div class="terminal-body" id="terminalBody"></div>
  </div>
</div>

<!-- ========== SCREEN 3: DASHBOARD ========== -->
<div class="dashboard-screen" id="dashboardScreen">
  <header class="header">
    <h1>DEFCON: RELATIONSHIP</h1>
    <div class="subtitle">THREAT ASSESSMENT COMPLETE</div>
  </header>

  <div class="source-bar" id="sourceBar">
    <span class="source-info" id="sourceInfo"></span>
    <button class="new-analysis-btn" id="newAnalysisBtn">NEW ANALYSIS</button>
  </div>

  <main class="dashboard">
    <section class="gauge-section" id="gaugeSection">
      <div class="card">
        <div class="card-header">// CURRENT THREAT LEVEL</div>
        <div class="gauge-container">
          <canvas id="gaugeCanvas" width="720" height="420"></canvas>
        </div>
        <div class="defcon-display">
          <div class="defcon-number" id="defconNumber">5</div>
          <div class="defcon-label" id="defconLabel">ALL CLEAR</div>
        </div>
      </div>
    </section>

    <section class="timeline-section">
      <div class="card">
        <div class="card-header">// INTERCEPTED SIGNALS</div>
        <div class="signal-list" id="signalList"></div>
      </div>
    </section>

    <section class="calendar-section">
      <div class="card">
        <div class="card-header">// DANGER ZONE CALENDAR</div>
        <div class="cal-header">
          <button class="cal-nav" id="calPrev">&lt;</button>
          <span id="calTitle">February 2026</span>
          <button class="cal-nav" id="calNext">&gt;</button>
        </div>
        <div class="calendar-grid" id="calGrid"></div>
      </div>
    </section>

    <section class="factors-section">
      <div class="card">
        <div class="card-header">// MOOD FACTOR ANALYSIS</div>
        <div class="factors-grid" id="factorsGrid"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    CLASSIFIED â€” BOYFRIEND INTELLIGENCE AGENCY (BIA) â€” UNAUTHORIZED ACCESS WILL RESULT IN SLEEPING ON THE COUCH
  </footer>
</div>

<script>
// ============================================================
// EMOJI DETECTION
// ============================================================
var EMOJI_RE = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{200D}\u{20E3}\u{E0020}-\u{E007F}]/gu;

function extractEmojis(text) {
  var matches = text.match(EMOJI_RE);
  return matches ? matches : [];
}

// ============================================================
// CHAT PARSER â€” handles WhatsApp, iMessage, generic formats
// ============================================================

function parseChat(rawText) {
  var lines = rawText.split('\n');
  var messages = [];
  var senders = {};

  // Detect format
  // WhatsApp: "1/15/24, 9:30 AM - Name: message" or "15/01/2024, 09:30 - Name: message"
  var whatsappRe = /^(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s+(\d{1,2}:\d{2}(?::\d{2})?\s*(?:AM|PM|am|pm)?)\s*[-â€“]\s*([^:]+):\s*(.+)$/;
  // iMessage / generic: "[2024-01-15 09:30:00] Name: message" or "[2024-01-15] Name: message"
  var imessageRe = /^\[?(\d{4}-\d{2}-\d{2}[\sT]\d{2}:\d{2}(?::\d{2})?)\]?\s*([^:]+):\s*(.+)$/;
  // Simpler generic: "09:30 AM - Name: message" or "9:30 - Name: message"
  var simpleRe = /^(\d{1,2}:\d{2}(?::\d{2})?\s*(?:AM|PM|am|pm)?)\s*[-â€“]\s*([^:]+):\s*(.+)$/;
  // Timestamp + name with no dash: "2024-01-15 09:30 Name: message"
  var looseRe = /^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})\s+([^:]+):\s*(.+)$/;

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) continue;

    var match = null;
    var dateStr = '';
    var timeStr = '';
    var sender = '';
    var text = '';

    if ((match = line.match(whatsappRe))) {
      dateStr = match[1];
      timeStr = match[2];
      sender = match[3].trim();
      text = match[4].trim();
    } else if ((match = line.match(imessageRe))) {
      var dt = match[1];
      dateStr = dt.split(/[\sT]/)[0];
      timeStr = dt.split(/[\sT]/)[1] || '00:00';
      sender = match[2].trim();
      text = match[3].trim();
    } else if ((match = line.match(simpleRe))) {
      timeStr = match[1];
      sender = match[2].trim();
      text = match[3].trim();
    } else if ((match = line.match(looseRe))) {
      dateStr = match[1].split(/\s+/)[0];
      timeStr = match[1].split(/\s+/)[1];
      sender = match[2].trim();
      text = match[3].trim();
    } else {
      // Continuation of previous message or unparseable
      if (messages.length > 0) {
        messages[messages.length - 1].text += ' ' + line;
        messages[messages.length - 1].emojis = extractEmojis(messages[messages.length - 1].text);
      }
      continue;
    }

    // Skip system messages
    if (text.indexOf('encryption') !== -1 || text.indexOf('created group') !== -1 || text.indexOf('changed the subject') !== -1) continue;
    if (text === '<Media omitted>' || text === 'image omitted' || text === 'sticker omitted') continue;

    senders[sender] = (senders[sender] || 0) + 1;

    messages.push({
      dateStr: dateStr,
      time: timeStr,
      sender: sender,
      text: text,
      emojis: extractEmojis(text),
      responseTimeMin: 0
    });
  }

  if (messages.length < 2) return null;

  // Identify "you" vs "her" â€” the person with fewer messages is more likely "you" (you reply less, obviously)
  var sortedSenders = Object.keys(senders).sort(function(a, b) { return senders[b] - senders[a]; });
  var primarySender = sortedSenders[0]; // most messages = "her"

  // Calculate response times (time between her message and your reply)
  for (var j = 1; j < messages.length; j++) {
    var prev = messages[j - 1];
    var curr = messages[j];
    if (prev.sender === primarySender && curr.sender !== primarySender) {
      // This is your reply to her â€” measure how long you took
      var delay = estimateMinutesBetween(prev, curr);
      curr.responseTimeMin = delay;
    } else if (prev.sender !== primarySender && curr.sender === primarySender) {
      // This is her reply to you
      var delay = estimateMinutesBetween(prev, curr);
      curr.responseTimeMin = delay;
    }
  }

  // Tag messages as "her" or "you"
  for (var k = 0; k < messages.length; k++) {
    messages[k].senderLabel = messages[k].sender === primarySender ? 'her' : 'you';
  }

  // Extract dates for calendar events
  var dateCounts = {};
  for (var m = 0; m < messages.length; m++) {
    var ds = messages[m].dateStr;
    if (ds) {
      dateCounts[ds] = (dateCounts[ds] || 0) + 1;
    }
  }

  return {
    messages: messages,
    primarySender: primarySender,
    senders: senders,
    totalMessages: messages.length,
    dateCounts: dateCounts
  };
}

function estimateMinutesBetween(prev, curr) {
  // Try to parse actual timestamps
  var t1 = parseTimeToMinutes(prev.time);
  var t2 = parseTimeToMinutes(curr.time);
  if (t1 !== null && t2 !== null) {
    var diff = t2 - t1;
    if (diff < 0) diff += 1440; // next day
    return diff;
  }
  return 5; // default fallback
}

function parseTimeToMinutes(timeStr) {
  if (!timeStr) return null;
  var clean = timeStr.trim().toUpperCase();
  var isPM = clean.indexOf('PM') !== -1;
  var isAM = clean.indexOf('AM') !== -1;
  clean = clean.replace(/\s*(AM|PM)/i, '');
  var parts = clean.split(':');
  var hours = parseInt(parts[0], 10);
  var minutes = parseInt(parts[1], 10) || 0;
  if (isNaN(hours)) return null;
  if (isPM && hours !== 12) hours += 12;
  if (isAM && hours === 12) hours = 0;
  return hours * 60 + minutes;
}

// ============================================================
// MOCK SCENARIOS
// ============================================================

var SCENARIOS = {
  'honeymoon': {
    name: 'Honeymoon Phase', emoji: '\u{1F495}',
    messages: [
      { time: '9:00 AM', text: 'good morning babe!! \u{1F495}\u{2600}\u{FE0F}\u{1F970}', responseTimeMin: 1, emojis: ['\u{1F495}','\u{2600}\u{FE0F}','\u{1F970}'], senderLabel: 'her' },
      { time: '9:01 AM', text: 'miss you already \u{1F618}\u{1F618}\u{1F618}', responseTimeMin: 1, emojis: ['\u{1F618}'], senderLabel: 'her' },
      { time: '9:15 AM', text: 'look at this cute dog i saw \u{1F415}\u{2764}\u{FE0F}', responseTimeMin: 2, emojis: ['\u{1F415}','\u{2764}\u{FE0F}'], senderLabel: 'her' },
      { time: '10:30 AM', text: 'thinking about you \u{1F97A}\u{1F497}', responseTimeMin: 3, emojis: ['\u{1F97A}','\u{1F497}'], senderLabel: 'her' },
      { time: '12:00 PM', text: 'lunch without you is so boring \u{1F62D}\u{1F495}', responseTimeMin: 2, emojis: ['\u{1F62D}','\u{1F495}'], senderLabel: 'her' },
      { time: '2:00 PM', text: 'cant wait for tonight!! \u{1F389}\u{1F60D}', responseTimeMin: 1, emojis: ['\u{1F389}','\u{1F60D}'], senderLabel: 'her' },
      { time: '6:30 PM', text: 'i love you so much it should be illegal \u{1F60D}\u{1F60D}\u{1F60D}', responseTimeMin: 1, emojis: ['\u{1F60D}'], senderLabel: 'her' },
    ],
    events: [
      { date: 14, title: "Valentine's Dinner \u2014 Reservation Confirmed", category: 'date', riskLevel: 0 },
      { date: 16, title: 'Weekend Getaway', category: 'date', riskLevel: 0 },
    ]
  },
  'forgot-anniversary': {
    name: 'Forgot Anniversary', emoji: '\u{1F480}',
    messages: [
      { time: '8:00 AM', text: 'hey', responseTimeMin: 45, emojis: [], senderLabel: 'her' },
      { time: '10:30 AM', text: 'so do you have any plans for tomorrow?', responseTimeMin: 120, emojis: [], senderLabel: 'her' },
      { time: '12:00 PM', text: 'just wondering', responseTimeMin: 30, emojis: [], senderLabel: 'her' },
      { time: '2:00 PM', text: 'fine', responseTimeMin: 5, emojis: [], senderLabel: 'her' },
      { time: '3:00 PM', text: 'k', responseTimeMin: 2, emojis: [], senderLabel: 'her' },
      { time: '5:00 PM', text: 'whatever', responseTimeMin: 180, emojis: [], senderLabel: 'her' },
      { time: '8:00 PM', text: 'its fine. really.', responseTimeMin: 60, emojis: [], senderLabel: 'her' },
      { time: '10:00 PM', text: 'goodnight.', responseTimeMin: 240, emojis: [], senderLabel: 'her' },
    ],
    events: [
      { date: 20, title: '2-Year Anniversary', category: 'anniversary', riskLevel: 100 },
      { date: 20, title: 'Your Calendar: "Gaming with the boys"', category: 'conflict', riskLevel: 100 },
      { date: 22, title: "Her Mom's Birthday (Did you get a gift?)", category: 'milestone', riskLevel: 80 },
    ]
  },
  'left-on-read': {
    name: 'Left on Read (6 Hours)', emoji: '\u{1F440}',
    messages: [
      { time: '10:00 AM', text: 'hey babe what do you want for dinner tonight? \u{1F355}', responseTimeMin: 3, emojis: ['\u{1F355}'], senderLabel: 'her' },
      { time: '10:03 AM', text: '??', responseTimeMin: 60, emojis: [], senderLabel: 'her' },
      { time: '11:00 AM', text: 'hello?', responseTimeMin: 60, emojis: [], senderLabel: 'her' },
      { time: '12:00 PM', text: "i can see you're online", responseTimeMin: 120, emojis: [], senderLabel: 'her' },
      { time: '2:00 PM', text: 'ok', responseTimeMin: 30, emojis: [], senderLabel: 'her' },
      { time: '3:30 PM', text: "nvm i'll figure it out myself", responseTimeMin: 180, emojis: [], senderLabel: 'her' },
      { time: '4:00 PM', text: "actually don't bother coming home for dinner", responseTimeMin: 0, emojis: [], senderLabel: 'her' },
    ],
    events: [
      { date: 19, title: 'You: Posted Instagram story at a bar', category: 'conflict', riskLevel: 90 },
      { date: 19, title: 'Her: Unfollowed your best friend', category: 'signal', riskLevel: 70 },
    ]
  },
  'liked-exs-post': {
    name: "Liked Ex's Instagram", emoji: '\u{2620}\u{FE0F}',
    messages: [
      { time: '9:00 AM', text: 'good morning \u{1F60A}', responseTimeMin: 2, emojis: ['\u{1F60A}'], senderLabel: 'her' },
      { time: '9:47 AM', text: 'interesting', responseTimeMin: 1, emojis: [], senderLabel: 'her' },
      { time: '9:48 AM', text: "so you're up at 9:47 huh", responseTimeMin: 1, emojis: [], senderLabel: 'her' },
      { time: '9:48 AM', text: 'busy liking photos?', responseTimeMin: 0, emojis: [], senderLabel: 'her' },
      { time: '9:50 AM', text: "it's fine", responseTimeMin: 300, emojis: [], senderLabel: 'her' },
      { time: '2:00 PM', text: "do you think she's pretty", responseTimeMin: 0, emojis: [], senderLabel: 'her' },
      { time: '2:00 PM', text: "don't answer that", responseTimeMin: 0, emojis: [], senderLabel: 'her' },
      { time: '6:00 PM', text: 'we need to talk.', responseTimeMin: 0, emojis: [], senderLabel: 'her' },
    ],
    events: [
      { date: 19, title: "Instagram: Liked ex's beach photo", category: 'catastrophe', riskLevel: 100 },
      { date: 19, title: 'Her: Changed Netflix password', category: 'signal', riskLevel: 95 },
    ]
  },
  'brought-flowers': {
    name: 'Brought Home Flowers', emoji: '\u{1F490}',
    messages: [
      { time: '9:00 AM', text: 'morning', responseTimeMin: 15, emojis: [], senderLabel: 'her' },
      { time: '12:00 PM', text: 'hey', responseTimeMin: 10, emojis: [], senderLabel: 'her' },
      { time: '5:30 PM', text: 'omg wait are those for me?? \u{1F97A}', responseTimeMin: 1, emojis: ['\u{1F97A}'], senderLabel: 'her' },
      { time: '5:31 PM', text: 'BABE \u{1F62D}\u{1F62D}\u{1F62D}\u{1F495}', responseTimeMin: 0, emojis: ['\u{1F62D}','\u{1F495}'], senderLabel: 'her' },
      { time: '5:32 PM', text: 'theyre so beautiful i cant \u{1F60D}\u{1F338}\u{1F490}\u{2764}\u{FE0F}', responseTimeMin: 0, emojis: ['\u{1F60D}','\u{1F338}','\u{1F490}','\u{2764}\u{FE0F}'], senderLabel: 'her' },
      { time: '5:33 PM', text: 'i love you i love you i love you \u{1F495}\u{1F495}\u{1F495}', responseTimeMin: 0, emojis: ['\u{1F495}'], senderLabel: 'her' },
      { time: '6:00 PM', text: 'ok what did you do wrong \u{1F914}', responseTimeMin: 5, emojis: ['\u{1F914}'], senderLabel: 'her' },
    ],
    events: [
      { date: 19, title: 'Flowers delivered', category: 'recovery', riskLevel: 0 },
      { date: 21, title: 'Date Night \u2014 her choice', category: 'date', riskLevel: 0 },
    ]
  },
  'we-need-to-talk': {
    name: '"We Need to Talk"', emoji: '\u{1FAA6}',
    messages: [
      { time: '7:00 AM', text: 'we need to talk.', responseTimeMin: 0, emojis: [], senderLabel: 'her' },
      { time: '7:00 AM', text: 'when you get home.', responseTimeMin: 0, emojis: [], senderLabel: 'her' },
      { time: '12:00 PM', text: "don't forget.", responseTimeMin: 0, emojis: [], senderLabel: 'her' },
    ],
    events: [
      { date: 19, title: 'The Talk', category: 'catastrophe', riskLevel: 100 },
      { date: 18, title: 'Her: Cleared browser history', category: 'signal', riskLevel: 80 },
      { date: 17, title: 'Her: Liked 47 posts by "Jake from work"', category: 'catastrophe', riskLevel: 95 },
    ]
  }
};

var DEFCON_LEVELS = {
  5: { label: 'ALL CLEAR', color: '#00ff41' },
  4: { label: 'SLIGHT DISTURBANCE', color: '#88ff00' },
  3: { label: 'PROCEED WITH CAUTION', color: '#ffdd00' },
  2: { label: 'DANGER ZONE', color: '#ff8c00' },
  1: { label: 'SLEEP ON THE COUCH', color: '#ff0040' }
};

// ============================================================
// GLOBAL STATE
// ============================================================

var currentData = null; // { messages, events, sourceName, messageCount }
var currentScores = {};
var calMonth = new Date().getMonth();
var calYear = new Date().getFullYear();
var gaugeAnimation = null;
var currentNeedleAngle = Math.PI;

// ============================================================
// SCORING ENGINE
// ============================================================

function calcResponseTimeScore(messages) {
  var herMsgs = messages.filter(function(m) { return m.senderLabel === 'her'; });
  if (!herMsgs.length) return 0;
  var times = herMsgs.map(function(m) { return m.responseTimeMin; });
  var avg = times.reduce(function(a, b) { return a + b; }, 0) / times.length;
  if (avg <= 3) return 0;
  if (avg >= 180) return 100;
  return Math.min(100, ((avg - 3) / 177) * 100);
}

function calcEmojiScore(messages) {
  var herMsgs = messages.filter(function(m) { return m.senderLabel === 'her'; });
  if (!herMsgs.length) return 50;
  var withEmojis = herMsgs.filter(function(m) { return m.emojis.length > 0; }).length;
  var ratio = withEmojis / herMsgs.length;
  if (ratio >= 0.6) return 0;
  if (ratio <= 0) return 100;
  return Math.min(100, ((0.6 - ratio) / 0.6) * 100);
}

function calcCalendarScore(events) {
  if (!events || !events.length) return 0;
  var maxRisk = Math.max.apply(null, events.map(function(e) { return e.riskLevel; }));
  var avgRisk = events.reduce(function(a, e) { return a + e.riskLevel; }, 0) / events.length;
  return Math.min(100, maxRisk * 0.7 + avgRisk * 0.3);
}

function calcTextLengthScore(messages) {
  var herMsgs = messages.filter(function(m) { return m.senderLabel === 'her'; });
  if (!herMsgs.length) return 0;
  var lengths = herMsgs.map(function(m) { return m.text.length; });
  var avg = lengths.reduce(function(a, b) { return a + b; }, 0) / lengths.length;
  if (avg >= 30) return 0;
  if (avg <= 3) return 100;
  return Math.min(100, ((30 - avg) / 27) * 100);
}

function calcFineIndex(messages) {
  var herMsgs = messages.filter(function(m) { return m.senderLabel === 'her'; });
  if (!herMsgs.length) return 0;
  var fineWords = ['fine', 'k', 'whatever', 'okay', 'sure', 'ok', 'nvm', 'nothing', 'nope'];
  var fineCount = herMsgs.filter(function(m) {
    var lower = m.text.toLowerCase().replace(/[^a-z\s']/g, '').trim();
    return fineWords.indexOf(lower) !== -1 || lower === "it's fine" || lower === 'its fine' || lower === 'its fine really';
  }).length;
  return Math.min(100, (fineCount / herMsgs.length) * 200);
}

function calcThreatLevel(messages, events) {
  var scores = {
    responseTime: calcResponseTimeScore(messages),
    emoji: calcEmojiScore(messages),
    calendar: calcCalendarScore(events),
    textLength: calcTextLengthScore(messages),
    fineIndex: calcFineIndex(messages)
  };

  var composite = scores.responseTime * 0.30 + scores.emoji * 0.20 + scores.calendar * 0.20 + scores.textLength * 0.15 + scores.fineIndex * 0.15;

  var defcon;
  if (composite <= 10) defcon = 5;
  else if (composite <= 30) defcon = 4;
  else if (composite <= 50) defcon = 3;
  else if (composite <= 75) defcon = 2;
  else defcon = 1;

  currentScores = { responseTime: scores.responseTime, emoji: scores.emoji, calendar: scores.calendar, textLength: scores.textLength, fineIndex: scores.fineIndex, composite: composite, defcon: defcon };
  return currentScores;
}

// ============================================================
// TERMINAL ANIMATION
// ============================================================

function runAnalysisAnimation(data, onComplete) {
  var body = document.getElementById('terminalBody');
  while (body.firstChild) body.removeChild(body.firstChild);

  var herMsgs = data.messages.filter(function(m) { return m.senderLabel === 'her'; });
  var avgResponse = herMsgs.reduce(function(a, m) { return a + m.responseTimeMin; }, 0) / (herMsgs.length || 1);
  var emojiRatio = herMsgs.filter(function(m) { return m.emojis.length > 0; }).length / (herMsgs.length || 1);
  var avgLen = herMsgs.reduce(function(a, m) { return a + m.text.length; }, 0) / (herMsgs.length || 1);
  var fineWords = ['fine', 'k', 'whatever', 'okay', 'sure', 'ok', 'nvm'];
  var fineCount = herMsgs.filter(function(m) { var l = m.text.toLowerCase().replace(/[^a-z\s']/g, '').trim(); return fineWords.indexOf(l) !== -1 || l.indexOf('fine') !== -1; }).length;

  var lines = [
    { text: '> Initializing BIA Threat Analysis Engine...', cls: 'term-green', delay: 60 },
    { text: '> Loading chat data...', cls: 'term-green', delay: 40 },
    { text: '  ' + data.messages.length + ' messages ingested from ' + Object.keys(data.senders || {}).length + ' participants', cls: 'term-dim', delay: 30 },
    { text: '  Primary contact identified: ' + (data.primarySender || data.sourceName), cls: 'term-dim', delay: 30 },
    { text: '', cls: '', delay: 10 },
    { text: '> SCANNING RESPONSE PATTERNS...', cls: 'term-green', delay: 50 },
    { text: '  Avg response time: ' + Math.round(avgResponse) + 'min (baseline: 3min)', cls: avgResponse > 30 ? 'term-red' : avgResponse > 10 ? 'term-orange' : 'term-dim', delay: 40 },
    { text: '  Score: ' + Math.round(currentScores.responseTime) + '/100 ' + (currentScores.responseTime > 75 ? '[CRITICAL]' : currentScores.responseTime > 50 ? '[ELEVATED]' : '[NOMINAL]'), cls: currentScores.responseTime > 75 ? 'term-red' : currentScores.responseTime > 50 ? 'term-orange' : 'term-green', delay: 40 },
    { text: '', cls: '', delay: 10 },
    { text: '> ANALYZING EMOJI SENTIMENT...', cls: 'term-green', delay: 50 },
    { text: '  Emoji frequency: ' + Math.round(emojiRatio * 100) + '% of messages', cls: emojiRatio < 0.2 ? 'term-red' : emojiRatio < 0.5 ? 'term-yellow' : 'term-dim', delay: 40 },
    { text: '  Score: ' + Math.round(currentScores.emoji) + '/100 ' + (currentScores.emoji > 75 ? '[EMOTIONAL SHUTDOWN]' : currentScores.emoji > 50 ? '[DECLINING]' : '[HEALTHY]'), cls: currentScores.emoji > 75 ? 'term-red' : currentScores.emoji > 50 ? 'term-orange' : 'term-green', delay: 40 },
    { text: '', cls: '', delay: 10 },
    { text: '> MEASURING TEXT LENGTH DECAY...', cls: 'term-green', delay: 50 },
    { text: '  Avg message length: ' + Math.round(avgLen) + ' chars', cls: avgLen < 10 ? 'term-red' : avgLen < 20 ? 'term-yellow' : 'term-dim', delay: 40 },
    { text: '  Score: ' + Math.round(currentScores.textLength) + '/100 ' + (currentScores.textLength > 75 ? '[MONOSYLLABIC]' : currentScores.textLength > 50 ? '[TERSE]' : '[NORMAL]'), cls: currentScores.textLength > 75 ? 'term-red' : currentScores.textLength > 50 ? 'term-orange' : 'term-green', delay: 40 },
    { text: '', cls: '', delay: 10 },
    { text: '> COMPUTING "FINE" INDEX...', cls: 'term-green', delay: 50 },
    { text: '  Passive-aggressive keywords detected: ' + fineCount + 'x', cls: fineCount >= 3 ? 'term-red' : fineCount >= 1 ? 'term-orange' : 'term-dim', delay: 40 },
    { text: '  Score: ' + Math.round(currentScores.fineIndex) + '/100 ' + (currentScores.fineIndex > 75 ? '[DANGER]' : currentScores.fineIndex > 25 ? '[MONITORING]' : '[CLEAR]'), cls: currentScores.fineIndex > 75 ? 'term-red' : currentScores.fineIndex > 25 ? 'term-yellow' : 'term-green', delay: 40 },
    { text: '', cls: '', delay: 10 },
    { text: '> COMPOSITE THREAT CALCULATION...', cls: 'term-green', delay: 60 },
    { text: '  Composite score: ' + Math.round(currentScores.composite) + '/100', cls: 'term-bright', delay: 50 },
    { text: '', cls: '', delay: 10 },
  ];

  // Final DEFCON line with dramatic color
  var defconColor = currentScores.defcon <= 2 ? 'term-red' : currentScores.defcon <= 3 ? 'term-yellow' : 'term-green';
  lines.push({ text: '  >>> DEFCON ' + currentScores.defcon + ': ' + DEFCON_LEVELS[currentScores.defcon].label + ' <<<', cls: defconColor, delay: 80 });
  lines.push({ text: '', cls: '', delay: 20 });
  lines.push({ text: '> Analysis complete. Loading dashboard...', cls: 'term-green', delay: 60 });

  var lineIndex = 0;

  function typeLine() {
    if (lineIndex >= lines.length) {
      setTimeout(onComplete, 600);
      return;
    }

    var lineData = lines[lineIndex];
    var lineEl = document.createElement('div');
    lineEl.className = 'term-line ' + lineData.cls;
    body.appendChild(lineEl);

    var charIndex = 0;
    var cursor = document.createElement('span');
    cursor.className = 'cursor';
    lineEl.appendChild(cursor);

    function typeChar() {
      if (charIndex >= lineData.text.length) {
        if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
        lineIndex++;
        body.scrollTop = body.scrollHeight;
        setTimeout(typeLine, 80);
        return;
      }
      if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
      lineEl.appendChild(document.createTextNode(lineData.text[charIndex]));
      lineEl.appendChild(cursor);
      charIndex++;
      body.scrollTop = body.scrollHeight;
      setTimeout(typeChar, lineData.delay + Math.random() * 15);
    }

    if (lineData.text === '') {
      if (cursor.parentNode) cursor.parentNode.removeChild(cursor);
      lineIndex++;
      setTimeout(typeLine, 200);
    } else {
      typeChar();
    }
  }

  typeLine();
}

// ============================================================
// SIGNAL GENERATION
// ============================================================

function generateSignals(messages, events) {
  var signals = [];
  var herMsgs = messages.filter(function(m) { return m.senderLabel === 'her'; });

  var avgResponse = herMsgs.reduce(function(a, m) { return a + m.responseTimeMin; }, 0) / (herMsgs.length || 1);
  if (avgResponse > 60) signals.push({ icon: '\u{1F6A8}', text: 'Avg response time: ' + Math.round(avgResponse) + 'min \u2014 baseline: 3min', severity: 'critical', time: 'ONGOING' });
  else if (avgResponse > 30) signals.push({ icon: '\u26A0\uFE0F', text: 'Response time elevated: ' + Math.round(avgResponse) + 'min avg', severity: 'high', time: 'ONGOING' });
  else if (avgResponse > 10) signals.push({ icon: '\u{1F4E1}', text: 'Response time slightly elevated: ' + Math.round(avgResponse) + 'min avg', severity: 'medium', time: 'ONGOING' });
  else signals.push({ icon: '\u2705', text: 'Response time nominal: ' + Math.round(avgResponse) + 'min avg', severity: 'low', time: 'ONGOING' });

  var emojiRatio = herMsgs.filter(function(m) { return m.emojis.length > 0; }).length / (herMsgs.length || 1);
  if (emojiRatio === 0) signals.push({ icon: '\u{1F534}', text: 'Emoji usage: ZERO \u2014 complete emotional shutdown detected', severity: 'critical', time: 'LAST 24H' });
  else if (emojiRatio < 0.2) signals.push({ icon: '\u26A0\uFE0F', text: 'Emoji usage dropped to ' + Math.round(emojiRatio * 100) + '% \u2014 normally 60%+', severity: 'high', time: 'LAST 24H' });
  else if (emojiRatio < 0.5) signals.push({ icon: '\u{1F4C9}', text: 'Emoji usage declining: ' + Math.round(emojiRatio * 100) + '%', severity: 'medium', time: 'LAST 24H' });
  else signals.push({ icon: '\u{1F495}', text: 'Emoji usage healthy: ' + Math.round(emojiRatio * 100) + '% of messages', severity: 'low', time: 'LAST 24H' });

  var avgLen = herMsgs.reduce(function(a, m) { return a + m.text.length; }, 0) / (herMsgs.length || 1);
  if (avgLen < 5) signals.push({ icon: '\u{1F534}', text: 'Avg text length: ' + Math.round(avgLen) + ' chars \u2014 monosyllabic responses', severity: 'critical', time: 'LAST 24H' });
  else if (avgLen < 15) signals.push({ icon: '\u26A0\uFE0F', text: 'Text length declining: ' + Math.round(avgLen) + ' chars avg', severity: 'high', time: 'LAST 24H' });

  var fineWords = ['fine', 'k', 'whatever', 'okay', 'sure', 'ok', 'nvm', 'nothing', 'nope'];
  var fineCount = herMsgs.filter(function(m) { var l = m.text.toLowerCase().replace(/[^a-z\s']/g, '').trim(); return fineWords.indexOf(l) !== -1 || l.indexOf("it's fine") !== -1 || l.indexOf('its fine') !== -1; }).length;
  if (fineCount >= 3) signals.push({ icon: '\u{1F480}', text: '"Fine" detected ' + fineCount + 'x \u2014 situation critical', severity: 'critical', time: 'LAST 24H' });
  else if (fineCount >= 1) signals.push({ icon: '\u{1F62C}', text: '"Fine/k/whatever" detected ' + fineCount + 'x \u2014 monitoring', severity: 'high', time: 'LAST 24H' });

  if (events) {
    for (var e = 0; e < events.length; e++) {
      var evt = events[e];
      var severity = evt.riskLevel >= 80 ? 'critical' : evt.riskLevel >= 50 ? 'high' : evt.riskLevel >= 20 ? 'medium' : 'low';
      var icon = evt.riskLevel >= 80 ? '\u{1F4C5}' : evt.riskLevel >= 50 ? '\u{1F4C6}' : '\u{1F5D3}\uFE0F';
      signals.push({ icon: icon, text: evt.title, severity: severity, time: 'FEB ' + evt.date });
    }
  }

  var weNeedToTalk = messages.find(function(m) { return m.text.toLowerCase().indexOf('we need to talk') !== -1; });
  if (weNeedToTalk) signals.push({ icon: '\u2622\uFE0F', text: '"We need to talk" \u2014 NUCLEAR OPTION DETECTED', severity: 'critical', time: weNeedToTalk.time || 'DETECTED' });

  var onlineSpy = messages.find(function(m) { var l = m.text.toLowerCase(); return l.indexOf("you're online") !== -1 || l.indexOf('can see you') !== -1; });
  if (onlineSpy) signals.push({ icon: '\u{1F441}\uFE0F', text: 'Online activity monitoring detected', severity: 'critical', time: onlineSpy.time || 'DETECTED' });

  var order = { critical: 0, high: 1, medium: 2, low: 3 };
  signals.sort(function(a, b) { return order[a.severity] - order[b.severity]; });
  return signals;
}

// ============================================================
// DASHBOARD RENDERERS
// ============================================================

function renderGauge(defcon) {
  var canvas = document.getElementById('gaugeCanvas');
  var ctx = canvas.getContext('2d');
  var w = canvas.width, h = canvas.height;
  var cx = w / 2, cy = h - 40;
  var radius = Math.min(cx, cy) - 30;
  var targetAngle = Math.PI + ((5 - defcon) / 4) * Math.PI;

  if (gaugeAnimation) cancelAnimationFrame(gaugeAnimation);

  function animate() {
    var diff = targetAngle - currentNeedleAngle;
    if (Math.abs(diff) < 0.005) { currentNeedleAngle = targetAngle; drawGauge(ctx, cx, cy, radius, w, h, currentNeedleAngle); return; }
    currentNeedleAngle += diff * 0.06;
    drawGauge(ctx, cx, cy, radius, w, h, currentNeedleAngle);
    gaugeAnimation = requestAnimationFrame(animate);
  }
  animate();
}

function drawGauge(ctx, cx, cy, radius, w, h, needleAngle) {
  ctx.clearRect(0, 0, w, h);
  var r = radius * 0.78;
  var segments = [
    { start: Math.PI,       end: Math.PI * 1.2, color: '#00ff41' },
    { start: Math.PI * 1.2, end: Math.PI * 1.4, color: '#88ff00' },
    { start: Math.PI * 1.4, end: Math.PI * 1.6, color: '#ffdd00' },
    { start: Math.PI * 1.6, end: Math.PI * 1.8, color: '#ff8c00' },
    { start: Math.PI * 1.8, end: Math.PI * 2,   color: '#ff0040' },
  ];
  // Background arc â€” dim base (upper semicircle, clockwise)
  for (var s = 0; s < segments.length; s++) {
    ctx.save();
    ctx.beginPath(); ctx.arc(cx, cy, r, segments[s].start, segments[s].end, false);
    ctx.lineWidth = 36; ctx.strokeStyle = segments[s].color; ctx.globalAlpha = 0.15; ctx.lineCap = 'butt'; ctx.stroke();
    ctx.restore();
  }
  // Active arc â€” bright with glow, from PI clockwise up to needle position
  for (var s = 0; s < segments.length; s++) {
    if (segments[s].start >= needleAngle) continue;
    var segEnd = Math.min(segments[s].end, needleAngle);
    ctx.save();
    ctx.beginPath(); ctx.arc(cx, cy, r, segments[s].start, segEnd, false);
    ctx.lineWidth = 36; ctx.strokeStyle = segments[s].color;
    ctx.shadowColor = segments[s].color; ctx.shadowBlur = 20;
    ctx.globalAlpha = 0.92; ctx.lineCap = 'butt'; ctx.stroke();
    ctx.restore();
  }
  // Tick marks and DEFCON labels (upper semicircle)
  for (var i = 0; i <= 4; i++) {
    var angle = Math.PI + (i / 4) * Math.PI;
    var cos = Math.cos(angle); var sin = Math.sin(angle);
    ctx.beginPath();
    ctx.moveTo(cx + cos * (r - 22), cy + sin * (r - 22));
    ctx.lineTo(cx + cos * (r + 22), cy + sin * (r + 22));
    ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = '#888'; ctx.font = 'bold 18px JetBrains Mono, monospace';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(String(5 - i), cx + cos * (r + 40), cy + sin * (r + 40));
  }
  // Needle â€” white with glow
  var nx = cx + Math.cos(needleAngle) * (r - 28);
  var ny = cy + Math.sin(needleAngle) * (r - 28);
  ctx.save();
  ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(nx, ny);
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 3;
  ctx.shadowColor = '#fff'; ctx.shadowBlur = 14; ctx.stroke();
  ctx.restore();
  // Center hub
  ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI * 2); ctx.fillStyle = '#1a1a1a'; ctx.fill();
  ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI * 2); ctx.fillStyle = '#fff'; ctx.fill();
}

function updateDefconDisplay(defcon) {
  var level = DEFCON_LEVELS[defcon];
  document.getElementById('defconNumber').textContent = String(defcon);
  document.getElementById('defconNumber').style.color = level.color;
  document.getElementById('defconLabel').textContent = level.label;
  document.getElementById('defconLabel').style.color = level.color;
  var section = document.getElementById('gaugeSection');
  section.className = 'gauge-section';
  if (defcon === 1) section.classList.add('defcon-1');
}

function renderSignals(signals) {
  var list = document.getElementById('signalList');
  while (list.firstChild) list.removeChild(list.firstChild);
  for (var i = 0; i < signals.length; i++) {
    var sig = signals[i];
    var item = document.createElement('div'); item.className = 'signal-item severity-' + sig.severity;
    var iconSpan = document.createElement('span'); iconSpan.className = 'signal-icon'; iconSpan.textContent = sig.icon;
    var body = document.createElement('div'); body.className = 'signal-body';
    var timeDiv = document.createElement('div'); timeDiv.className = 'signal-time'; timeDiv.textContent = sig.time;
    var textDiv = document.createElement('div'); textDiv.className = 'signal-text'; textDiv.textContent = sig.text;
    body.appendChild(timeDiv); body.appendChild(textDiv);
    var badge = document.createElement('span'); badge.className = 'signal-badge ' + sig.severity; badge.textContent = sig.severity.toUpperCase();
    item.appendChild(iconSpan); item.appendChild(body); item.appendChild(badge);
    list.appendChild(item);
  }
}

function renderCalendar(events) {
  var grid = document.getElementById('calGrid');
  var title = document.getElementById('calTitle');
  var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  title.textContent = monthNames[calMonth] + ' ' + calYear;
  var firstDay = new Date(calYear, calMonth, 1).getDay();
  var daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  var today = new Date();
  var isCurrentMonth = today.getMonth() === calMonth && today.getFullYear() === calYear;
  var eventMap = {};
  if (events) {
    for (var e = 0; e < events.length; e++) {
      if (!eventMap[events[e].date]) eventMap[events[e].date] = [];
      eventMap[events[e].date].push(events[e]);
    }
  }
  while (grid.firstChild) grid.removeChild(grid.firstChild);
  var dayNames = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  for (var dn = 0; dn < dayNames.length; dn++) {
    var el = document.createElement('div'); el.className = 'cal-day-name'; el.textContent = dayNames[dn]; grid.appendChild(el);
  }
  for (var i = 0; i < firstDay; i++) { var el = document.createElement('div'); el.className = 'cal-day empty'; grid.appendChild(el); }
  for (var d = 1; d <= daysInMonth; d++) {
    var el = document.createElement('div');
    var evts = eventMap[d] || [];
    var maxRisk = evts.length ? Math.max.apply(null, evts.map(function(ev) { return ev.riskLevel; })) : -1;
    var threatClass = 'threat-none';
    if (maxRisk >= 80) threatClass = 'threat-critical';
    else if (maxRisk >= 50) threatClass = 'threat-high';
    else if (maxRisk >= 20) threatClass = 'threat-medium';
    else if (maxRisk >= 0 && evts.length) threatClass = 'threat-low';
    el.className = 'cal-day ' + threatClass;
    if (isCurrentMonth && d === today.getDate()) el.classList.add('today');
    el.textContent = String(d);
    if (evts.length) {
      var dot = document.createElement('span'); dot.className = 'event-dot'; el.appendChild(dot);
      var tooltip = document.createElement('div'); tooltip.className = 'tooltip';
      tooltip.textContent = evts.map(function(ev) { return ev.title; }).join(' | ');
      el.appendChild(tooltip);
    }
    grid.appendChild(el);
  }
}

function renderFactors(messages) {
  var grid = document.getElementById('factorsGrid');
  var herMsgs = messages.filter(function(m) { return m.senderLabel === 'her'; });
  var avgResponse = herMsgs.reduce(function(a, m) { return a + m.responseTimeMin; }, 0) / (herMsgs.length || 1);
  var emojiRatio = herMsgs.filter(function(m) { return m.emojis.length > 0; }).length / (herMsgs.length || 1);
  var avgLen = herMsgs.reduce(function(a, m) { return a + m.text.length; }, 0) / (herMsgs.length || 1);

  var factors = [
    { name: 'Response Time', score: currentScores.responseTime, weight: '30%', detail: 'Avg reply: ' + Math.round(avgResponse) + 'min' },
    { name: 'Emoji Sentiment', score: currentScores.emoji, weight: '20%', detail: Math.round(emojiRatio * 100) + '% of messages contain emoji' },
    { name: 'Calendar Risk', score: currentScores.calendar, weight: '20%', detail: (currentData.events ? currentData.events.length : 0) + ' event(s) analyzed' },
    { name: 'Text Length', score: currentScores.textLength, weight: '15%', detail: 'Avg message: ' + Math.round(avgLen) + ' chars' },
    { name: '"Fine" Index', score: currentScores.fineIndex, weight: '15%', detail: 'Passive-aggressive keyword frequency' }
  ];

  while (grid.firstChild) grid.removeChild(grid.firstChild);
  for (var i = 0; i < factors.length; i++) {
    var f = factors[i];
    var color = f.score >= 75 ? 'var(--red)' : f.score >= 50 ? 'var(--orange)' : f.score >= 25 ? 'var(--yellow)' : 'var(--green)';
    var el = document.createElement('div'); el.className = 'factor';
    var labelDiv = document.createElement('div'); labelDiv.className = 'factor-label';
    var nameSpan = document.createElement('span'); nameSpan.className = 'factor-name'; nameSpan.textContent = f.name + ' (' + f.weight + ')';
    var valueSpan = document.createElement('span'); valueSpan.className = 'factor-value'; valueSpan.style.color = color; valueSpan.textContent = Math.round(f.score) + '/100';
    labelDiv.appendChild(nameSpan); labelDiv.appendChild(valueSpan);
    var barDiv = document.createElement('div'); barDiv.className = 'factor-bar';
    var fillDiv = document.createElement('div'); fillDiv.className = 'factor-fill'; fillDiv.style.backgroundColor = color; fillDiv.setAttribute('data-width', String(f.score));
    barDiv.appendChild(fillDiv);
    var detailDiv = document.createElement('div'); detailDiv.className = 'factor-detail'; detailDiv.textContent = f.detail;
    el.appendChild(labelDiv); el.appendChild(barDiv); el.appendChild(detailDiv);
    grid.appendChild(el);
  }
  requestAnimationFrame(function() {
    var fills = document.querySelectorAll('.factor-fill');
    for (var j = 0; j < fills.length; j++) fills[j].style.width = fills[j].getAttribute('data-width') + '%';
  });
}

// ============================================================
// SCREEN TRANSITIONS
// ============================================================

function showScreen(name) {
  document.getElementById('uploadScreen').style.display = name === 'upload' ? '' : 'none';
  document.getElementById('uploadScreen').classList.remove('hidden');
  document.getElementById('analysisScreen').classList.toggle('active', name === 'analysis');
  document.getElementById('dashboardScreen').classList.toggle('active', name === 'dashboard');
}

function launchAnalysis(data) {
  currentData = data;
  calcThreatLevel(data.messages, data.events || []);

  showScreen('analysis');

  runAnalysisAnimation(data, function() {
    showScreen('dashboard');

    // Update source bar
    var info = document.getElementById('sourceInfo');
    info.textContent = '';
    var strong = document.createElement('strong');
    strong.textContent = data.sourceName;
    info.appendChild(strong);
    info.appendChild(document.createTextNode(' \u2014 ' + data.messages.length + ' messages analyzed'));

    // Render dashboard
    currentNeedleAngle = Math.PI;
    updateDefconDisplay(currentScores.defcon);
    renderGauge(currentScores.defcon);
    renderSignals(generateSignals(data.messages, data.events || []));
    renderCalendar(data.events || []);
    renderFactors(data.messages);
  });
}

// ============================================================
// FILE UPLOAD HANDLING
// ============================================================

function handleFile(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    var text = e.target.result;
    var parsed = parseChat(text);

    if (!parsed || parsed.messages.length < 2) {
      alert('Could not parse chat file. Make sure it\'s a text export from iMessage, WhatsApp, or similar format.');
      return;
    }

    launchAnalysis({
      messages: parsed.messages,
      events: [],
      sourceName: file.name,
      primarySender: parsed.primarySender,
      senders: parsed.senders
    });
  };
  reader.readAsText(file);
}

var dropzone = document.getElementById('dropzone');
var fileInput = document.getElementById('fileInput');

dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', function() { dropzone.classList.remove('dragover'); });
dropzone.addEventListener('drop', function(e) {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', function() { if (fileInput.files.length) handleFile(fileInput.files[0]); });

// ============================================================
// DEMO BUTTONS
// ============================================================

(function() {
  var container = document.getElementById('demoButtons');
  var keys = Object.keys(SCENARIOS);
  for (var i = 0; i < keys.length; i++) {
    var key = keys[i];
    var sc = SCENARIOS[key];
    var btn = document.createElement('button');
    btn.className = 'demo-btn';
    btn.textContent = sc.emoji + ' ' + sc.name;
    btn.addEventListener('click', (function(k) {
      return function() {
        var scenario = SCENARIOS[k];
        launchAnalysis({
          messages: scenario.messages,
          events: scenario.events,
          sourceName: scenario.name,
          primarySender: 'her',
          senders: { 'her': scenario.messages.length }
        });
      };
    })(key));
    container.appendChild(btn);
  }
})();

// ============================================================
// NEW ANALYSIS BUTTON
// ============================================================

document.getElementById('newAnalysisBtn').addEventListener('click', function() {
  currentNeedleAngle = Math.PI;
  showScreen('upload');
});

// ============================================================
// CALENDAR NAVIGATION
// ============================================================

document.getElementById('calPrev').addEventListener('click', function() {
  calMonth--;
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar(currentData ? currentData.events : []);
});

document.getElementById('calNext').addEventListener('click', function() {
  calMonth++;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  renderCalendar(currentData ? currentData.events : []);
});

// ============================================================
// INIT â€” start on upload screen
// ============================================================

showScreen('upload');
</script>
</body>
</html>
